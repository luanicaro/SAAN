<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Criador de Formulários - Dark Mode</title>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* --- TEMA DARK --- */
        :root {
            --bg-body: #0f172a;
            --bg-card: #1e293b;
            --bg-input: #0f172a;
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --primary: #3b82f6;
            --primary-hover: #2563eb;
            --border: #334155;
            --danger: #ef4444;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            padding-bottom: 40px;
        }

        /* --- LAYOUT --- */
        .navbar {
            background-color: var(--bg-card);
            border-bottom: 1px solid var(--border);
            padding: 16px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 32px;
        }
        .nav-link { color: var(--text-muted); text-decoration: none; font-size: 0.9rem; margin-left: 20px; transition: color 0.2s; }
        .nav-link:hover { color: var(--primary); }

        .container { max-width: 800px; margin: 0 auto; padding: 0 20px; }

        /* --- HEADER PAGE --- */
        .page-header { margin-bottom: 32px; }
        .page-header h1 { font-size: 2rem; font-weight: 700; color: var(--text-main); }
        .page-header p { color: var(--text-muted); margin-top: 8px; }

        /* --- INPUTS & FORMS --- */
        .form-section { display: flex; flex-direction: column; gap: 20px; margin-bottom: 32px; }
        
        label { display: block; font-weight: 500; color: var(--text-muted); margin-bottom: 8px; font-size: 0.9rem; }
        
        input[type="text"], textarea {
            width: 100%;
            padding: 14px;
            background-color: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: white;
            font-size: 1rem;
            transition: border-color 0.2s;
        }
        input:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
            background-color: #252b36; 
        }

        /* --- CARDS (Perguntas) --- */
        .question-card {
            background-color: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            position: relative;
        }
        .question-number {
            position: absolute;
            top: 24px; right: 24px;
            color: var(--text-muted);
            font-weight: 700;
            opacity: 0.5;
        }

        /* --- COGA EXAMPLE BOX (Dark Theme) --- */
        .example-box {
            background-color: rgba(59, 130, 246, 0.1); /* Azul muito transparente */
            border: 1px solid rgba(59, 130, 246, 0.2);
            border-radius: 8px;
            padding: 16px;
            margin-top: 16px;
        }
        .example-label { color: var(--primary); font-size: 0.85rem; font-weight: 600; margin-bottom: 8px; display: block; }
        .input-example { border-color: rgba(59, 130, 246, 0.3) !important; background-color: rgba(15, 23, 42, 0.5) !important; }

        /* --- UPLOAD AREA --- */
        .upload-area {
            border: 2px dashed var(--border);
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            margin-bottom: 32px;
            background-color: rgba(30, 41, 59, 0.5);
        }
        .btn-upload {
            background-color: var(--bg-card);
            border: 1px solid var(--border);
            color: var(--text-main);
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            display: inline-flex;
            align-items: center; gap: 8px;
            transition: all 0.2s;
        }
        .btn-upload:hover { border-color: var(--primary); color: var(--primary); }

        /* --- ACTIONS --- */
        .btn-add {
            width: 100%;
            padding: 16px;
            background: transparent;
            border: 2px dashed var(--border);
            color: var(--text-muted);
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
            display: flex; justify-content: center; align-items: center; gap: 8px;
        }
        .btn-add:hover { border-color: var(--primary); color: var(--primary); background-color: rgba(59, 130, 246, 0.05); }

        .btn-delete {
            background: transparent; border: none; color: var(--danger);
            cursor: pointer; font-size: 0.9rem; display: flex; align-items: center; gap: 6px;
            margin-top: 16px; opacity: 0.8;
        }
        .btn-delete:hover { opacity: 1; text-decoration: underline; }
        .btn-delete:disabled { filter: grayscale(1); cursor: not-allowed; }

        .footer-actions {
            margin-top: 40px;
            display: flex; justify-content: flex-end; gap: 16px;
            padding-top: 20px; border-top: 1px solid var(--border);
        }
        
        .btn-cancel {
            background: transparent; border: 1px solid var(--border);
            color: var(--text-main); padding: 12px 24px; border-radius: 8px; cursor: pointer;
        }
        .btn-save {
            background-color: var(--primary); border: none;
            color: white; padding: 12px 32px; border-radius: 8px; font-weight: 600; cursor: pointer;
            display: flex; align-items: center; gap: 8px;
        }
        .btn-save:hover { background-color: var(--primary-hover); }

        /* --- ALERTS --- */
        .alert {
            padding: 16px; border-radius: 8px; margin-bottom: 24px;
            display: flex; align-items: center; gap: 12px;
            background-color: var(--bg-card); border-left: 4px solid var(--primary);
        }
        .alert.hidden { display: none; }
        .alert-success { background-color: rgba(22, 163, 74, 0.1); border-color: #22c55e; color: #4ade80; }
        .alert-error { background-color: rgba(239, 68, 68, 0.1); border-color: #ef4444; color: #f87171; }

    </style>
</head>
<body>

    <nav class="navbar">
        <div style="font-weight: 700; display: flex; align-items: center; gap: 8px;">
            <i data-lucide="layers"></i> Avaliação de Acessibilidade
        </div>
        <div>
            <a href="/" class="nav-link">Início</a>
            <a href="visualizar.html" class="nav-link">Visualizar</a>
        </div>
    </nav>

    <div class="container">
        
        <div class="page-header">
            <h1>Criar Novo Formulário</h1>
            <p>Configure as perguntas que serão apresentadas na interface escura.</p>
        </div>

        <main>
            <div id="feedback-success" class="alert alert-success hidden" role="alert" tabindex="-1" style="flex-direction: column; align-items: flex-start;">
                <div style="display: flex; align-items: center; gap: 12px; font-weight: bold; font-size: 1.1rem;">
                    <i data-lucide="check-circle"></i>
                    <span>Salvo com sucesso!</span>
                </div>
                <p style="margin: 8px 0 16px 36px; opacity: 0.9;">
                    O formulário está pronto. O que deseja fazer?
                </p>
                <div style="margin-left: 36px; display: flex; gap: 12px;">
                    <a href="/" class="btn-upload" style="text-decoration: none;">
                        <i data-lucide="home" style="width: 16px;"></i> Início
                    </a>
                    <button type="button" class="btn-upload" onclick="resetForm()">
                        <i data-lucide="plus-circle" style="width: 16px;"></i> Novo
                    </button>
                </div>
            </div>

            <div id="feedback-import" class="alert hidden" style="border-color: var(--primary); color: var(--primary);">
                <i data-lucide="check-circle"></i> <span>Perguntas importadas! Preencha os exemplos.</span>
            </div>
            <div id="feedback-error" class="alert alert-error hidden">
                <i data-lucide="alert-circle"></i> <span>Erro ao salvar. Verifique o servidor.</span>
            </div>
            <div id="feedback-validation" class="alert alert-error hidden">
                <i data-lucide="alert-circle"></i> <span>Preencha o título.</span>
            </div>
            <div id="feedback-file-empty" class="alert alert-error hidden">
                <i data-lucide="alert-circle"></i> <span>Arquivo vazio.</span>
            </div>

            <section class="form-section">
                <div>
                    <label for="form-title">Título do Formulário *</label>
                    <input type="text" id="form-title" placeholder="Ex: Avaliação de Contraste">
                </div>
                <div>
                    <label for="form-desc">Descrição</label>
                    <textarea id="form-desc" rows="2" placeholder="Objetivo da avaliação..."></textarea>
                </div>
            </section>

            <section class="upload-area">
                <h3 style="margin-bottom: 8px; font-size: 1rem;">Importar Perguntas (TXT)</h3>
                <p style="color: var(--text-muted); font-size: 0.85rem; margin-bottom: 16px;">Cada linha do arquivo será uma nova pergunta.</p>
                <input type="file" id="file-input" accept=".txt,.md,.csv" style="display: none;">
                <button type="button" class="btn-upload" onclick="document.getElementById('file-input').click()">
                    <i data-lucide="upload" style="width: 16px;"></i> Selecionar Arquivo
                </button>
            </section>

            <div id="questions-container">
                </div>

            <button type="button" class="btn-add" onclick="addQuestion()">
                <i data-lucide="plus"></i> Adicionar Pergunta Manual
            </button>

            <div class="footer-actions">
                <button type="button" class="btn-cancel" onclick="location.href='/'">Cancelar</button>
                <button type="button" class="btn-save" onclick="handleSave()">
                    <i data-lucide="save" style="width: 18px;"></i> Salvar
                </button>
            </div>
        </main>
    </div>

    <script>
        let questions = [{ id: 1, text: '', example: '', scaleType: '5-point' }];

        document.addEventListener('DOMContentLoaded', () => {
            renderQuestions();
            setupFileUpload();
        });

        function renderQuestions() {
            const container = document.getElementById('questions-container');
            container.innerHTML = '';

            questions.forEach((q, index) => {
                const card = document.createElement('div');
                card.className = 'question-card';
                card.innerHTML = `
                    <div class="question-number">#${index + 1}</div>
                    
                    <div style="margin-bottom: 16px;">
                        <label>Pergunta</label>
                        <input type="text" value="${q.text}" 
                            placeholder="Digite a pergunta aqui..." 
                            oninput="updateQuestion(${q.id}, 'text', this.value)">
                    </div>

                    <div class="example-box">
                        <span class="example-label"><i data-lucide="help-circle" style="width:12px; display:inline"></i> Exemplo de Apoio (Contexto)</span>
                        <input type="text" class="input-example" 
                            value="${q.example}" 
                            placeholder="Ajude o avaliador a entender..."
                            oninput="updateQuestion(${q.id}, 'example', this.value)">
                    </div>

                    <button type="button" class="btn-delete" onclick="removeQuestion(${q.id})" ${questions.length === 1 ? 'disabled' : ''}>
                        <i data-lucide="trash-2" style="width: 14px;"></i> Remover Pergunta
                    </button>
                `;
                container.appendChild(card);
            });
            lucide.createIcons();
        }

        function addQuestion() {
            const maxId = questions.length > 0 ? Math.max(...questions.map(q => q.id)) : 0;
            questions.push({ id: maxId + 1, text: '', example: '', scaleType: '5-point' });
            renderQuestions();
        }

        function removeQuestion(id) {
            if (questions.length <= 1) return;
            questions = questions.filter(q => q.id !== id);
            renderQuestions();
        }

        function updateQuestion(id, field, value) {
            const q = questions.find(item => item.id === id);
            if (q) q[field] = value;
        }

        function setupFileUpload() {
            const fileInput = document.getElementById('file-input');
            fileInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    const lines = e.target.result.split(/\r?\n/).filter(line => line.trim() !== '');
                    if (lines.length === 0) { showFeedback('feedback-file-empty'); return; }
                    
                    if (questions.length === 1 && questions[0].text.trim() === '') questions = [];
                    
                    const maxId = questions.length > 0 ? Math.max(...questions.map(q => q.id)) : 0;
                    const newQs = lines.map((line, idx) => ({ id: maxId + idx + 1, text: line.trim(), example: '', scaleType: '5-point' }));
                    questions = [...questions, ...newQs];
                    renderQuestions();
                    showFeedback('feedback-import');
                    fileInput.value = '';
                };
                reader.onerror = () => showFeedback('feedback-error');
                reader.readAsText(file);
            });
        }

        function resetForm() {
            document.getElementById('form-title').value = '';
            document.getElementById('form-desc').value = '';
            questions = [{ id: 1, text: '', example: '', scaleType: '5-point' }];
            renderQuestions();
            document.getElementById('feedback-success').classList.add('hidden');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        async function handleSave() {
            const title = document.getElementById('form-title').value;
            if (!title.trim()) { showFeedback('feedback-validation'); return; }

            const payload = { title, description: document.getElementById('form-desc').value, questions };

            try {
                const res = await fetch('http://localhost:3000/api/forms', {
                    method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload)
                });
                if (res.ok) {
                    document.getElementById('feedback-error').classList.add('hidden');
                    document.getElementById('feedback-validation').classList.add('hidden');
                    const success = document.getElementById('feedback-success');
                    success.classList.remove('hidden');
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                    success.focus();
                } else { showFeedback('feedback-error'); }
            } catch (e) { showFeedback('feedback-error'); }
        }

        function showFeedback(id) {
            ['feedback-success', 'feedback-error', 'feedback-import', 'feedback-file-empty', 'feedback-validation'].forEach(eid => document.getElementById(eid).classList.add('hidden'));
            const el = document.getElementById(id);
            if(el) { el.classList.remove('hidden'); if(id !== 'feedback-success') setTimeout(() => el.classList.add('hidden'), 4000); }
        }
    </script>
</body>
</html>